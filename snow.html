<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snowfall Effect</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        /* background: transparent; */
        background: black;
      }

      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <script type="module">
      const getUrlParam = (key, defaultValue) =>
        new URLSearchParams(window.location.search).get(key) ?? defaultValue;
      const ALPHA_FACTOR = 81; // 3**4
      const PI2 = Math.PI * 2;
      const FRAME_DURATION_IN_MS = 16.67;
      const X_N_SCREEN = 2;
      // const wind_decay = maxWind ** (1 / fps);
      const WIND_DECAY = 0.9995;

      // для настройки через URL: `/snow.html?count=200&maxWind=10`
      const COUNT = Number(getUrlParam("count", 200)) * X_N_SCREEN;
      const MAX_WIND = Number(getUrlParam("maxWind", 10));

      class CanvasService {
        canvas = document.createElement("canvas");
        ctx = this.canvas.getContext("2d");
        constructor() {
          this.updateCanvasSize();
        }
        updateCanvasSize = () => {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        };
      }

      class WindService {
        globalWind = Math.random() - 0.5;

        updateGlobalWind() {
          this.globalWind =
            Math.max(
              -MAX_WIND,
              Math.min(MAX_WIND, this.globalWind + (Math.random() * 0.2 - 0.1))
            ) * WIND_DECAY;
        }
      }

      class Snowflake {
        canvas;
        x;
        y;
        radius = Math.random() * 3 + 1;
        speed = Math.random() * 2 + 1;
        wind = Math.random() * 1 - 0.5;
        wind_z = Math.random() * 0.02 - 0.01;
        alpha = 1;

        constructor(canvas) {
          this.canvas = canvas;
          this.x = Math.random() * this.canvas.width;
          this.y = Math.random() * this.canvas.height;
          this.updateAlpha();
        }

        updateAlpha() {
          const r2 = this.radius * this.radius;
          this.alpha = ALPHA_FACTOR / (r2 * r2);
        }

        reset(canvasWidth) {
          this.radius = Math.random() * 3 + 1;
          this.speed = Math.random() * 2 + 1;
          this.wind = Math.random() * 1 - 0.5;
          this.wind_z = Math.random() * 0.01 - 0.005;
          this.x =
            Math.random() * canvasWidth * X_N_SCREEN -
            (canvasWidth * (X_N_SCREEN - 1)) / 2;
          this.y = -10;
          this.updateAlpha();
        }

        updateX(dt, globalWind) {
          this.x += (this.wind + globalWind) * dt;
        }

        updateY(dt) {
          this.y += (this.radius + 1) * dt;
        }

        updateRadius(dt) {
          this.radius += this.wind_z * dt;
          this.updateAlpha();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const { canvas, ctx, updateCanvasSize } = new CanvasService();
        const wind = new WindService();
        const snowflakes = Array.from(
          { length: COUNT },
          () => new Snowflake(canvas)
        );

        const startSnowfall = () => {
          let lastTime = performance.now();

          const animateSnowfall = (timestamp) => {
            const dt = (timestamp - lastTime) / FRAME_DURATION_IN_MS;
            lastTime = timestamp;

            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            wind.updateGlobalWind();

            const globalWind = wind.globalWind;

            snowflakes.forEach((snowflake) => {
              snowflake.updateY(dt);
              snowflake.updateX(dt, globalWind);
              snowflake.updateRadius(dt);

              const alpha = snowflake.alpha;

              if (
                snowflake.y > canvasHeight ||
                snowflake.radius < 0 ||
                alpha <= 0.01
              ) {
                snowflake.reset(canvasWidth);
              } else if (
                snowflake.x > -50 &&
                snowflake.x < canvasWidth + 50
              ) {
                ctx.fillStyle = `rgba(255,255,255,${Math.min(1, alpha)})`;
                ctx.beginPath();
                ctx.arc(snowflake.x, snowflake.y, snowflake.radius, 0, PI2);
                ctx.fill();
              }
            });

            requestAnimationFrame(animateSnowfall);
          };

          requestAnimationFrame(animateSnowfall);

          window.addEventListener("resize", updateCanvasSize);

          document.body.append(canvas);
        };

        startSnowfall();
      });
    </script>
  </body>
</html>
