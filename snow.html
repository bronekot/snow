<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snowfall Effect</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        /* background: transparent; */
        background: black;
      }

      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <canvas id="snowCanvas"></canvas>

    <script>
      const canvas = document.getElementById("snowCanvas");
      const ctx = canvas.getContext("2d");

      const maxWind = 10;
      const x_n_screen = 2;
      // const wind_decay = maxWind ** (1 / fps);
      const wind_decay = 0.9995;
      const alphaFactor = 81; // 3**4
      const PI2 = Math.PI * 2;

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const snowflakes = [];
      const count = Math.round(120 * x_n_screen);
      for (let i = 0; i < count; i++) snowflakes.push(createSnowflakeFirst());

      let wind_global = Math.random() - 0.5;
      let lastTime = performance.now();

      function resetSnowflake(s, initial = false) {
        const radius = Math.random() * 3 + 1;
        s.radius = radius;
        s.radius4 = radius * radius * radius * radius;
        s.speed = Math.random() * 2 + 1;
        s.wind = Math.random() * 1 - 0.5;
        s.wind_z = Math.random() * (initial ? 0.02 : 0.01) - (initial ? 0.01 : 0.005);
        s.x = initial
          ? Math.random() * canvas.width
          : Math.random() * canvas.width * x_n_screen -
            (canvas.width * (x_n_screen - 1)) / 2;
        s.y = initial ? Math.random() * canvas.height : -10;
      }

      function createSnowflake() {
        const radius = Math.random() * 3 + 1;
        return {
          x:
            Math.random() * canvas.width * x_n_screen -
            (canvas.width * (x_n_screen - 1)) / 2,
          y: -10,
          radius: radius,
          radius4: radius * radius * radius * radius,
          speed: Math.random() * 2 + 1,
          wind: Math.random() * 1 - 0.5,
          wind_z: Math.random() * 0.01 - 0.005,
        };
      }

      function createSnowflakeFirst() {
        const radius = Math.random() * 3 + 1;
        return {
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: radius,
          radius4: radius * radius * radius * radius,
          speed: Math.random() * 2 + 1,
          wind: Math.random() * 1 - 0.5,
          wind_z: Math.random() * 0.02 - 0.01,
        };
      }

      function animateSnowfall(timestamp) {
        const dt = (timestamp - lastTime) / 16.67; // нормируем к ~60fps
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        wind_global = Math.max(
          -maxWind,
          Math.min(maxWind, wind_global + (Math.random() * 0.2 - 0.1))
        );
        wind_global *= wind_decay;

        for (let i = 0; i < snowflakes.length; i++) {
          const s = snowflakes[i];

          s.radius4 = s.radius * s.radius * s.radius * s.radius;

          const alpha = alphaFactor / s.radius4;

          if (alpha > 0.01) {
            ctx.fillStyle = `rgba(255,255,255,${alpha > 1 ? 1 : alpha})`;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.radius, 0, PI2);
            ctx.fill();
          }

          s.y += (s.radius + 1) * dt;
          s.x += (s.wind + wind_global) * dt;
          s.radius += s.wind_z * dt;

          if (s.y > canvas.height || s.radius < 0 || alpha <= 0.01)
            resetSnowflake(s);
        }

        requestAnimationFrame(animateSnowfall);
      }
      requestAnimationFrame(animateSnowfall);

      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    </script>
  </body>
</html>
